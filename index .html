<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>首角度ロガー（傾斜センサのみ）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
      margin: 0;
      padding: 12px;
      background: #fafafa;
      color: #111;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .box {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    button {
      font-size: 16px;
      padding: 8px 12px;
      margin: 4px 4px 4px 0;
    }
    .angle {
      font-size: 32px;
      font-weight: 600;
      text-align: center;
      margin: 8px 0;
    }
    .label {
      font-size: 14px;
      color: #555;
    }
    .status {
      font-size: 14px;
      color: #333;
      margin-top: 4px;
    }
    .small {
      font-size: 13px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>首角度ロガー（傾斜センサのみ）</h1>

  <div class="box">
    <div class="label">1. iOS の場合はまず「センサ許可」を押してください</div>
    <button id="btnPerm">センサ許可をリクエスト（iOS用）</button>
    <div id="permStatus" class="status">状態: 未確認</div>
  </div>

  <div class="box">
    <div class="label">2. 良い姿勢で正面を向いて「基準姿勢を登録」</div>
    <button id="btnCalib">基準姿勢を登録</button>
    <div class="small">※このときの頭の角度を 0° として扱います</div>
    <div id="calibStatus" class="status">基準: 未設定</div>
  </div>

  <div class="box">
    <div class="label">現在の首角度（基準からの相対角度）</div>
    <div id="angleDisplay" class="angle">--.- °</div>
    <div class="small">
      <span id="rawDisplay">生の beta: --.- °</span><br>
      <span id="tsDisplay">更新時刻: --:--:--</span>
    </div>
  </div>

  <div class="box">
    <div class="label">3. ログ記録（CSV用）</div>
    <button id="btnStart">ログ開始</button>
    <button id="btnStop" disabled>ログ停止</button>
    <button id="btnDownload" disabled>CSVダウンロード</button>
    <button id="btnClear">ログ全削除</button>
    <div id="logStatus" class="status">ログ件数: 0</div>
    <div class="small">
      1秒ごとに「時刻・経過時間・首角度」を記録します。<br>
      別のスマホ（姿勢アプリ側）のログと「時刻」や「経過時間」で合わせてください。
    </div>
  </div>

  <script>
    // ==== 状態変数 ====
    let latestBeta = null;      // デバイスからの生の beta[deg]
    let baseBeta = null;        // キャリブ時の beta[deg]
    let lastUpdateTime = null;  // 最終更新時刻 Date

    let logging = false;
    let logStartTime = null;    // Date
    let logTimerId = null;
    let logData = [];           // ログ配列

    const angleDisplay = document.getElementById('angleDisplay');
    const rawDisplay   = document.getElementById('rawDisplay');
    const tsDisplay    = document.getElementById('tsDisplay');
    const permStatus   = document.getElementById('permStatus');
    const calibStatus  = document.getElementById('calibStatus');
    const logStatus    = document.getElementById('logStatus');

    const btnPerm      = document.getElementById('btnPerm');
    const btnCalib     = document.getElementById('btnCalib');
    const btnStart     = document.getElementById('btnStart');
    const btnStop      = document.getElementById('btnStop');
    const btnDownload  = document.getElementById('btnDownload');
    const btnClear     = document.getElementById('btnClear');

    // ==== 1. DeviceOrientation 許可（主に iOS 用） ====
    btnPerm.addEventListener('click', async () => {
      try {
        if (window.DeviceOrientationEvent &&
            typeof DeviceOrientationEvent.requestPermission === 'function') {
          const res = await DeviceOrientationEvent.requestPermission();
          if (res === 'granted') {
            permStatus.textContent = '状態: 許可されました ✅';
          } else {
            permStatus.textContent = '状態: 拒否されました ❌';
          }
        } else {
          permStatus.textContent = '状態: この端末/ブラウザでは明示的な許可は不要か、非対応です';
        }
      } catch (e) {
        console.error(e);
        permStatus.textContent = '状態: 許可リクエスト中にエラーが発生しました';
      }
    });

    // ==== 2. DeviceOrientation イベント登録 ====
    window.addEventListener('deviceorientation', (event) => {
      // beta: 前後の傾き（頭を前に倒すと変化）
      if (event.beta == null) return;

      latestBeta = event.beta;  // 単位は[deg]
      lastUpdateTime = new Date();

      updateAngleDisplay();
    });

    function updateAngleDisplay() {
      if (latestBeta == null) return;

      // 相対角度（基準からの差分）
      let relativeDeg = latestBeta;
      if (baseBeta != null) {
        relativeDeg = latestBeta - baseBeta;
      }
      // 小数1桁表示
      const relativeStr = relativeDeg.toFixed(1);
      const rawStr = latestBeta.toFixed(1);

      angleDisplay.textContent = `${relativeStr} °`;
      rawDisplay.textContent = `生の beta: ${rawStr} °`;

      if (lastUpdateTime) {
        const h = String(lastUpdateTime.getHours()).padStart(2, '0');
        const m = String(lastUpdateTime.getMinutes()).padStart(2, '0');
        const s = String(lastUpdateTime.getSeconds()).padStart(2, '0');
        tsDisplay.textContent = `更新時刻: ${h}:${m}:${s}`;
      }
    }

    // ==== 3. 基準姿勢の登録 ====
    btnCalib.addEventListener('click', () => {
      if (latestBeta == null) {
        alert('センサの値がまだ取得できていません。少し端末を動かしてみてください。');
        return;
      }
      baseBeta = latestBeta;
      calibStatus.textContent = `基準: beta=${baseBeta.toFixed(1)} ° を 0° として扱います`;
      updateAngleDisplay();
    });

    // ==== 4. ログ処理 ====

    btnStart.addEventListener('click', () => {
      if (logging) return;
      if (latestBeta == null) {
        alert('センサの値がまだ取得できていません。少し端末を動かしてみてください。');
        return;
      }
      logging = true;
      logStartTime = new Date();

      btnStart.disabled = true;
      btnStop.disabled = false;

      // 1秒間隔でログ
      logTimerId = setInterval(pushLog, 1000);
      logStatus.textContent = `ログ件数: ${logData.length}（記録中…）`;
    });

    btnStop.addEventListener('click', () => {
      if (!logging) return;
      logging = false;
      btnStart.disabled = false;
      btnStop.disabled = true;

      if (logTimerId != null) {
        clearInterval(logTimerId);
        logTimerId = null;
      }
      logStatus.textContent = `ログ件数: ${logData.length}（停止中）`;
      if (logData.length > 0) {
        btnDownload.disabled = false;
      }
    });

    btnClear.addEventListener('click', () => {
      logData = [];
      logStatus.textContent = 'ログ件数: 0';
      btnDownload.disabled = true;
    });

    btnDownload.addEventListener('click', () => {
      if (logData.length === 0) {
        alert('ログがありません。');
        return;
      }
      const csv = makeCSV(logData);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      a.download = `head_tilt_${y}${m}${d}_${hh}${mm}${ss}.csv`;
      a.href = url;
      a.click();

      URL.revokeObjectURL(url);
    });

    function pushLog() {
      if (!logging || latestBeta == null || !logStartTime) return;

      const now = new Date();
      const elapsedMs = now - logStartTime;

      let relativeDeg = latestBeta;
      if (baseBeta != null) {
        relativeDeg = latestBeta - baseBeta;
      }

      const row = {
        time_iso: now.toISOString(),       // UTC表記（あとでJSTに直してもOK）
        elapsed_ms: elapsedMs,
        head_pitch_deg: relativeDeg,
        raw_beta_deg: latestBeta
      };
      logData.push(row);
      logStatus.textContent = `ログ件数: ${logData.length}（記録中…）`;
    }

    function makeCSV(data) {
      const header = ['time_iso', 'elapsed_ms', 'head_pitch_deg', 'raw_beta_deg'];
      const lines = [];
      lines.push(header.join(','));

      for (const row of data) {
        const line = [
          row.time_iso,
          row.elapsed_ms,
          row.head_pitch_deg.toFixed(4),
          row.raw_beta_deg.toFixed(4),
        ].join(',');
        lines.push(line);
      }
      return lines.join('\n');
    }
  </script>
</body>
</html>
